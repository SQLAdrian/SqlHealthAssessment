<!--/* In the name of God, the Merciful, the Compassionate */-->@using System.IO
@using SqlHealthAssessment.Data
@using SqlHealthAssessment.Data.Models
@inject IDbConnectionFactory ConnectionFactory
@inject NavigationManager Navigation
@inject AutoRefreshService AutoRefreshService
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@inject UserSettingsService UserSettings
@inject GlobalInstanceSelector InstanceSelector
@inject ServerConnectionManager ConnectionManager

<div class="toolbar">
    <div class="toolbar-group">
        <label class="toolbar-label">Refresh:</label>
        <select class="toolbar-select" @onchange="OnRefreshIntervalChanged">
            <option value="5" selected="@(RefreshIntervalSeconds == 5)">5 sec</option>
            <option value="10" selected="@(RefreshIntervalSeconds == 10)">10 sec</option>
            <option value="15" selected="@(RefreshIntervalSeconds == 15)">15 sec</option>
            <option value="30" selected="@(RefreshIntervalSeconds == 30)">30 sec</option>
            <option value="60" selected="@(RefreshIntervalSeconds == 60)">60 sec</option>
        </select>
    </div>

    <div class="toolbar-group">
        <label class="toolbar-label">Time Range:</label>
        <select class="toolbar-select" @onchange="OnTimeRangeChanged">
            <option value="5" selected="@(TimeRangeMinutes == 5)">Last 5 min</option>
            <option value="15" selected="@(TimeRangeMinutes == 15)">Last 15 min</option>
            <option value="60" selected="@(TimeRangeMinutes == 60)">Last 1 hour</option>
            <option value="360" selected="@(TimeRangeMinutes == 360)">Last 6 hours</option>
            <option value="1440" selected="@(TimeRangeMinutes == 1440)">Last 24 hours</option>
            <option value="10080" selected="@(TimeRangeMinutes == 10080)">Last 7 days</option>
        </select>
    </div>

    
    <div class="toolbar-group">
        <label class="toolbar-label">Timezone:</label>
        <select class="toolbar-select" @onchange="OnTimezoneChanged">
            <option value="-12" selected="@(TimezoneOffsetHours == -12)">UTC-12</option>
            <option value="-11" selected="@(TimezoneOffsetHours == -11)">UTC-11</option>
            <option value="-10" selected="@(TimezoneOffsetHours == -10)">UTC-10</option>
            <option value="-9" selected="@(TimezoneOffsetHours == -9)">UTC-9</option>
            <option value="-8" selected="@(TimezoneOffsetHours == -8)">UTC-8 (PST)</option>
            <option value="-7" selected="@(TimezoneOffsetHours == -7)">UTC-7 (MST)</option>
            <option value="-6" selected="@(TimezoneOffsetHours == -6)">UTC-6 (CST)</option>
            <option value="-5" selected="@(TimezoneOffsetHours == -5)">UTC-5 (EST)</option>
            <option value="-4" selected="@(TimezoneOffsetHours == -4)">UTC-4 (AST)</option>
            <option value="-3" selected="@(TimezoneOffsetHours == -3)">UTC-3</option>
            <option value="-2" selected="@(TimezoneOffsetHours == -2)">UTC-2</option>
            <option value="-1" selected="@(TimezoneOffsetHours == -1)">UTC-1</option>
            <option value="0" selected="@(TimezoneOffsetHours == 0)">UTC</option>
            <option value="1" selected="@(TimezoneOffsetHours == 1)">UTC+1 (CET)</option>
            <option value="2" selected="@(TimezoneOffsetHours == 2)">UTC+2</option>
            <option value="3" selected="@(TimezoneOffsetHours == 3)">UTC+3</option>
            <option value="4" selected="@(TimezoneOffsetHours == 4)">UTC+4</option>
            <option value="5" selected="@(TimezoneOffsetHours == 5)">UTC+5</option>
            <option value="6" selected="@(TimezoneOffsetHours == 6)">UTC+6</option>
            <option value="7" selected="@(TimezoneOffsetHours == 7)">UTC+7</option>
            <option value="8" selected="@(TimezoneOffsetHours == 8)">UTC+8 (CST China)</option>
            <option value="9" selected="@(TimezoneOffsetHours == 9)">UTC+9 (JST)</option>
            <option value="10" selected="@(TimezoneOffsetHours == 10)">UTC+10</option>
            <option value="11" selected="@(TimezoneOffsetHours == 11)">UTC+11</option>
            <option value="12" selected="@(TimezoneOffsetHours == 12)">UTC+12</option>
            <option value="13" selected="@(TimezoneOffsetHours == 13)">UTC+13 (NZST)</option>
        </select>
    </div>

    <div class="toolbar-group">
        <button class="toolbar-btn @(AutoRefresh ? "active" : "")" @onclick="ToggleAutoRefresh">
            @(AutoRefresh ? "‚è∏ Pause" : "‚ñ∂ Auto-Refresh")
        </button>
        <button class="toolbar-btn" @onclick="() => OnRefreshRequested.InvokeAsync()">
            üîÑ Refresh
        </button>
    </div>

    <!--
    <div class="toolbar-status">
        <button class="server-name-btn" @onclick="OpenSettings">
            <span class="status-dot @(ConnectionFactory.DataSourceType == "SqlServer" ? "status-sql" : "status-liveQueries")"></span>
            @ServerDisplayName
        </button>
    </div>
    -->

</div>

@code {
    [Parameter] public int TimeRangeMinutes { get; set; } = 60;
    [Parameter] public EventCallback<int> TimeRangeMinutesChanged { get; set; }
    [Parameter] public bool AutoRefresh { get; set; } = true;
    [Parameter] public EventCallback<bool> AutoRefreshChanged { get; set; }
    [Parameter] public EventCallback OnRefreshRequested { get; set; }
    [Parameter] public double TimezoneOffsetHours { get; set; } = 0;
    [Parameter] public EventCallback<double> TimezoneOffsetHoursChanged { get; set; }
    [Parameter] public EventCallback OnServerChanged { get; set; }

    private string ServerDisplayName = "SqlServer";
    private int RefreshIntervalSeconds = 35;

    // Server connection dropdown state
    private List<ServerConnection> ServerConnections = new();
    private string SelectedServerId = "";

    protected override void OnInitialized()
    {
        // Extract server name for display without exposing the full connection string
        if (ConnectionFactory is SqlServerConnectionFactory sqlFactory)
        {
            var serverName = sqlFactory.ServerName;
            if (!string.IsNullOrEmpty(serverName))
                ServerDisplayName = serverName;
        }

        // Load refresh interval from configuration
        RefreshIntervalSeconds = int.TryParse(Configuration["RefreshIntervalSeconds"], out var seconds) ? seconds : 35;

        // Load timezone from user settings (default to UTC+13 for NZ)
        TimezoneOffsetHours = UserSettings.GetTimezoneOffset();

        // Populate server connection list from the manager
        ServerConnections = ConnectionManager.GetEnabledConnections();

        // Select the current server, or the first enabled one
        var current = ConnectionManager.CurrentServer;
        if (current != null)
        {
            SelectedServerId = current.Id;
        }
        else if (ServerConnections.Count > 0)
        {
            SelectedServerId = ServerConnections[0].Id;
            ConnectionManager.SetCurrentServer(SelectedServerId);
        }

        // Keep display name in sync with selected server
        UpdateServerDisplayName();
    }

    private void UpdateServerDisplayName()
    {
        var conn = ConnectionManager.CurrentServer;
        if (conn != null && !string.IsNullOrWhiteSpace(conn.ServerNames))
        {
            ServerDisplayName = conn.ServerNames.Split('\n', ',')[0].Trim();
        }
        else if (ConnectionFactory is SqlServerConnectionFactory sqlFactory)
        {
            var sn = sqlFactory.ServerName;
            if (!string.IsNullOrEmpty(sn))
                ServerDisplayName = sn;
        }
    }

    private async Task OnServerConnectionChanged(ChangeEventArgs e)
    {
        var serverId = e.Value?.ToString() ?? "";
        if (serverId == SelectedServerId) return;

        SelectedServerId = serverId;
        ConnectionManager.SetCurrentServer(serverId);
        UpdateServerDisplayName();

        // Notify the parent dashboard to reload data with the new connection context
        await OnServerChanged.InvokeAsync();
    }

    private async Task OnRefreshIntervalChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var seconds))
        {
            RefreshIntervalSeconds = seconds;
            
            // Update the auto-refresh service
            AutoRefreshService.SetInterval(seconds);
            
            // Save to appsettings.json
            await SaveRefreshIntervalToConfig(seconds);
        }
    }

    private async Task SaveRefreshIntervalToConfig(int seconds)
    {
        try
        {
            var configPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "appsettings.json");
            var json = await File.ReadAllTextAsync(configPath);
            var config = System.Text.Json.JsonDocument.Parse(json);
            var root = config.RootElement;
            
            // Create a new JSON object with updated value
            var newConfig = new System.Text.StringBuilder();
            newConfig.AppendLine("{");
            
            foreach (var prop in root.EnumerateObject())
            {
                if (prop.Name == "RefreshIntervalSeconds")
                {
                    newConfig.AppendLine($"  \"RefreshIntervalSeconds\": {seconds},");
                }
                else if (prop.Value.ValueKind == System.Text.Json.JsonValueKind.String)
                {
                    newConfig.AppendLine($"  \"{prop.Name}\": \"{prop.Value.GetString()}\",");
                }
                else if (prop.Value.ValueKind == System.Text.Json.JsonValueKind.Number)
                {
                    newConfig.AppendLine($"  \"{prop.Name}\": {prop.Value.GetRawText()},");
                }
                else if (prop.Value.ValueKind == System.Text.Json.JsonValueKind.True || prop.Value.ValueKind == System.Text.Json.JsonValueKind.False)
                {
                    newConfig.AppendLine($"  \"{prop.Name}\": {prop.Value.GetBoolean().ToString().ToLower()},");
                }
                else if (prop.Value.ValueKind == System.Text.Json.JsonValueKind.Object)
                {
                    newConfig.AppendLine($"  \"{prop.Name}\": {prop.Value.GetRawText()},");
                }
            }
            
            newConfig.AppendLine("}");
            
            // Remove trailing comma before closing brace on the previous line
            var finalJson = newConfig.ToString().Replace(",\n  }", "\n  }");
            await File.WriteAllTextAsync(configPath, finalJson);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error saving refresh interval: {ex.Message}");
        }
    }

    private async Task OnTimeRangeChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var minutes))
        {
            TimeRangeMinutes = minutes;
            await TimeRangeMinutesChanged.InvokeAsync(minutes);
        }
    }

    private async Task OnTimezoneChanged(ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var offset))
        {
            TimezoneOffsetHours = offset;
            UserSettings.SetTimezoneOffset(offset);
            await TimezoneOffsetHoursChanged.InvokeAsync(offset);
        }
    }

    private async Task ToggleAutoRefresh()
    {
        AutoRefresh = !AutoRefresh;
        await AutoRefreshChanged.InvokeAsync(AutoRefresh);
    }

    private void OpenSettings()
    {
        Navigation.NavigateTo("/settings");
    }
}
