<!--/* In the name of God, the Merciful, the Compassionate */-->
@using System.Data

@using SqlHealthAssessment.Data
@using SqlHealthAssessment.Data.Models
@inject IJSRuntime JS

@switch (Panel.PanelType)
{
    case "TimeSeries":
        <TimeSeriesChart Title="@Panel.Title"
                         Data="@TimeSeriesData"
                         Height="@Panel.Height"
                         ChartSeriesType="@MapChartType()"
                         TimezoneOffsetHours="@TimezoneOffsetHours" />
        break;

    case "StatCard":
        @if (StatData != null)
        {
            <StatCard Label="@Panel.Title"
                      Value="@StatData.Value"
                      Unit="@Panel.StatUnit"
                      Color="@StatData.Color"
                      ValueFormat="@Panel.ValueFormat" />
        }
        break;

    case "DeltaStatCard":
        @if (StatData != null)
        {
            <DeltaStatCard Label="@Panel.Title"
                           Value="@StatData.Value"
                           Unit="@Panel.StatUnit"
                           Color="@StatData.Color"
                           ValueFormat="@Panel.ValueFormat" />
        }
        break;

    case "BarGauge":
        @if (BarGaugeData != null)
        {
            <CollapsibleSection Title="@Panel.Title" IsExpanded="true">
                <div style="padding: 8px 16px;">
                    @foreach (var item in BarGaugeData)
                    {
                        <BarGauge Label="@item.Label"
                                  Value="@item.Value"
                                  ThresholdKey="@(Panel.BarGaugeThresholdKey ?? "")"
                                  UnitSuffix="@Panel.BarGaugeUnitSuffix"
                                  ValueFormat="@Panel.ValueFormat" />
                    }
                </div>
            </CollapsibleSection>
        }
        break;

    case "DataGrid":
        <DataGrid Title="@Panel.Title"
                  Data="@GridData"
                  IsClickable="@Panel.DataGridIsClickable"
                  MaxRows="@Panel.DataGridMaxRows"
                  HiddenColumns="@_planHiddenColumns"
                  PlanIndicatorColumn="@(GridData != null && GridData.Columns.Contains("Plan") ? "Plan" : null)"
                  OnRowClick="@OnDataGridRowClick"
                  TopRowsConfig="@(Panel.DataGridTopRows > 0 ? TopRowsValue : null)"
                  OnTopRowsConfigChanged="@OnTopRowsConfigChanged" />
        <QueryPlanModal @ref="_queryPlanModal" />
        break;

    case "CheckStatus":
        @if (CheckData != null)
        {
            @foreach (var check in CheckData)
            {
                <StatCard Label="@check.Status"
                          Value="@check.Count"
                          Unit="" />
            }
        }
        break;

    case "TextCard":
        @if (GridData != null && GridData.Rows.Count > 0)
        {
            <CollapsibleSection Title="@Panel.Title" IsExpanded="true">
                <div style="display: flex; flex-wrap: wrap; gap: 12px; padding: 16px;">
                    @foreach (DataRow row in GridData.Rows)
                    {
                        @foreach (DataColumn column in GridData.Columns)
                        {
                            var value = row[column];
                            <div class="stat-card-mini">
                                <div class="stat-card-label">@column.ColumnName</div>
                                <div class="stat-card-value">@ConvertToText(value)</div>
                            </div>
                        }
                    }
                </div>
            </CollapsibleSection>
        }
        break;

    case "SessionBubble":
        <div class="text-card-container" style="text-align: center; padding: 24px;">
            <h4 class="text-card-title">@Panel.Title</h4>
            <p style="color: var(--text-secondary); margin: 12px 0;">
                The live session bubble view is available as a dedicated page.
            </p>
            <a href="/sessions" style="color: var(--accent); text-decoration: underline;">
                Open Live Sessions
            </a>
        </div>
        break;
}

@code {
    [Parameter] public PanelDefinition Panel { get; set; } = new();
    [Parameter] public List<TimeSeriesPoint>? TimeSeriesData { get; set; }
    [Parameter] public double TimezoneOffsetHours { get; set; } = 0;
    [Parameter] public StatValue? StatData { get; set; }
    [Parameter] public List<StatValue>? BarGaugeData { get; set; }
    [Parameter] public DataTable? GridData { get; set; }
    [Parameter] public List<CheckStatus>? CheckData { get; set; }
    [Parameter] public int? TopRowsValue { get; set; }
    [Parameter] public EventCallback<int> OnTopRowsConfigChanged { get; set; }

    private QueryPlanModal? _queryPlanModal;

    // Hide [Plan] column in grids that have it â€” shown via modal on row click instead
    private static readonly HashSet<string> _planHiddenColumns = new(StringComparer.OrdinalIgnoreCase) { "Plan" };

    private async Task OnDataGridRowClick(DataRow row)
    {
        if (_queryPlanModal == null) return;
        if (!row.Table.Columns.Contains("Plan")) return;

        var xml = row["Plan"]?.ToString();
        if (string.IsNullOrWhiteSpace(xml)) return;

        // Extract query text if present
        string? queryText = null;
        foreach (var candidate in new[] { "query_text", "QueryText", "sql_text", "text", "statement_text" })
        {
            if (row.Table.Columns.Contains(candidate) && row[candidate] != DBNull.Value)
            {
                queryText = row[candidate]?.ToString();
                break;
            }
        }

        await _queryPlanModal.ShowAsync(xml, queryText);
    }

    private ApexCharts.SeriesType MapChartType()
    {
        return Panel.ChartType switch
        {
            "Bar" => ApexCharts.SeriesType.Bar,
            "Area" => ApexCharts.SeriesType.Area,
            _ => ApexCharts.SeriesType.Line
        };
    }

    // Helper method for TextCard panel type
    private string ConvertToText(object value)
    {
        if (value == null || value == DBNull.Value) return "N/A";
        return value.ToString() ?? "N/A";
    }
}
