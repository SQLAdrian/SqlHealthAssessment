<!--/* In the name of God, the Merciful, the Compassionate */-->
@using System.Data

@using SqlHealthAssessment.Data
@using SqlHealthAssessment.Data.Models

@switch (Panel.PanelType)
{
    case "TimeSeries":
        <TimeSeriesChart Title="@Panel.Title"
                         Data="@TimeSeriesData"
                         Height="@Panel.Height"
                         ChartSeriesType="@MapChartType()"
                         TimezoneOffsetHours="@TimezoneOffsetHours" />
        break;

    case "StatCard":
        @if (StatData != null)
        {
            <StatCard Label="@Panel.Title"
                      Value="@StatData.Value"
                      Unit="@Panel.StatUnit"
                      Color="@StatData.Color"
                      ValueFormat="@Panel.ValueFormat" />
        }
        break;

    case "DeltaStatCard":
        @if (StatData != null)
        {
            <DeltaStatCard Label="@Panel.Title"
                           Value="@StatData.Value"
                           Unit="@Panel.StatUnit"
                           Color="@StatData.Color"
                           ValueFormat="@Panel.ValueFormat" />
        }
        break;

    case "BarGauge":
        @if (BarGaugeData != null)
        {
            <CollapsibleSection Title="@Panel.Title" IsExpanded="true">
                <div style="padding: 8px 16px;">
                    @foreach (var item in BarGaugeData)
                    {
                        <BarGauge Label="@item.Label"
                                  Value="@item.Value"
                                  ThresholdKey="@(Panel.BarGaugeThresholdKey ?? "")"
                                  UnitSuffix="@Panel.BarGaugeUnitSuffix"
                                  ValueFormat="@Panel.ValueFormat" />
                    }
                </div>
            </CollapsibleSection>
        }
        break;

    case "DataGrid":
        <DataGrid Title="@Panel.Title"
                  Data="@GridData"
                  IsClickable="@Panel.DataGridIsClickable"
                  MaxRows="@Panel.DataGridMaxRows" />
        break;

    case "CheckStatus":
        @if (CheckData != null)
        {
            @foreach (var check in CheckData)
            {
                <StatCard Label="@check.Status"
                          Value="@check.Count"
                          Unit="" />
            }
        }
        break;

    case "TextCard":
        @if (GridData != null && GridData.Rows.Count > 0)
        {
            @foreach (DataRow row in GridData.Rows)
            {
                <div class="text-card-container">
                    <h4 class="text-card-title">@Panel.Title</h4>
                    @if (!string.IsNullOrEmpty(Panel.Description))
                    {
                        <div class="text-card-description">@Panel.Description</div>
                    }
                    <div class="text-card-content">
                        @foreach (DataColumn column in GridData.Columns)
                        {
                            var value = row[column];
                            <div class="text-card-item">
                                <span class="text-card-label">@column.ColumnName:</span>
                                <span class="text-card-value">@ConvertToText(value)</span>
                            </div>
                        }
                    </div>
                </div>
            }
        }
        break;

    case "SessionBubble":
        <div class="text-card-container" style="text-align: center; padding: 24px;">
            <h4 class="text-card-title">@Panel.Title</h4>
            <p style="color: var(--text-secondary); margin: 12px 0;">
                The live session bubble view is available as a dedicated page.
            </p>
            <a href="/sessions" style="color: var(--accent); text-decoration: underline;">
                Open Live Sessions
            </a>
        </div>
        break;
}

@code {
    [Parameter] public PanelDefinition Panel { get; set; } = new();
    [Parameter] public List<TimeSeriesPoint>? TimeSeriesData { get; set; }
    [Parameter] public double TimezoneOffsetHours { get; set; } = 0;
    [Parameter] public StatValue? StatData { get; set; }
    [Parameter] public List<StatValue>? BarGaugeData { get; set; }
    [Parameter] public DataTable? GridData { get; set; }
    [Parameter] public List<CheckStatus>? CheckData { get; set; }

    private ApexCharts.SeriesType MapChartType()
    {
        return Panel.ChartType switch
        {
            "Bar" => ApexCharts.SeriesType.Bar,
            "Area" => ApexCharts.SeriesType.Area,
            _ => ApexCharts.SeriesType.Line
        };
    }

    // Helper method for TextCard panel type
    private string ConvertToText(object value)
    {
        if (value == null || value == DBNull.Value) return "N/A";
        return value.ToString() ?? "N/A";
    }
}
