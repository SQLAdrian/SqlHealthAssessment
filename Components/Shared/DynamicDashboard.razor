<!--/* In the name of God, the Merciful, the Compassionate */-->
@using System.Data

@using System.Collections.Concurrent
@using SqlHealthAssessment.Data
@using SqlHealthAssessment.Data.Caching
@using SqlHealthAssessment.Data.Models
@inject DashboardConfigService ConfigService
@inject DashboardDataService DataService
@inject QueryExecutor QueryExecutor
@inject CachingQueryExecutor CachingExecutor
@inject AutoRefreshService RefreshService
@inject UserSettingsService UserSettings
@inject ServerConnectionManager ConnectionManager
@inject GlobalInstanceSelector InstanceSelector
@inject QueryThrottleService QueryThrottle
@implements IDisposable


@if (ConnectionManager.CurrentServer != null)
{
    <div class="server-context-header">
        <span class="server-context-icon">üñ•Ô∏è</span>
        <span class="server-context-label">Connected to:</span>
        <span class="server-context-name">@ConnectionManager.CurrentServer.ServerNames</span>
        <span class="server-context-db">(@ConnectionManager.CurrentServer.Database)</span>
    </div>
}

<DashboardToolbar @bind-TimeRangeMinutes="TimeRangeMinutes"
                  @bind-SelectedInstance="SelectedInstance"
                  @bind-AutoRefresh="AutoRefresh"
                  @bind-TimezoneOffsetHours="TimezoneOffsetHours"
                  ShowAllOption="@(Dashboard?.ShowAllOption ?? false)"
                  OnRefreshRequested="OnManualRefresh"
                  OnServerChanged="OnServerConnectionChanged" />

<div class="dashboard-content">
    @if (CachingExecutor.IsServingStaleData)
    {
        <div class="chart-empty" style="color: #ff9800; background: #2a2000; border: 1px solid #ff9800; padding: 10px; margin: 8px; border-radius: 4px;">
            &#9888; SQL Server unreachable. Showing cached data from @(CachingExecutor.LastSuccessfulFetch?.ToString("HH:mm:ss") ?? "unknown")
        </div>
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="chart-empty" style="color: #f44336; background: #2a1a1a; border: 1px solid #f44336; padding: 12px; margin: 8px; border-radius: 4px;">
            @ErrorMessage
        </div>
    }

    @* Show panel errors *@
    @if (_panelErrors.Any())
    {
        <div class="chart-empty" style="color: #ff9800; background: #2a2000; border: 1px solid #ff9800; padding: 12px; margin: 8px; border-radius: 4px;">
            <strong>&#9888; Data Load Warnings:</strong>
            <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                @foreach (var err in _panelErrors)
                {
                    <li>@err.Key: @err.Value</li>
                }
            </ul>
        </div>
    }

    @if (IsLoading)
    {
        <div class="chart-empty">Loading data...</div>
    }
    else if (Dashboard != null)
    {
        @* Stat cards section *@
        @if (_statPanelsCache?.Any() == true)
        {
            <div class="stat-grid">
                @foreach (var panel in _statPanelsCache)
                {
                    if (panel.PanelType == "CheckStatus" && _checkResults.TryGetValue(panel.Id, out var checks))
                    {
                        <DynamicPanel Panel="panel" CheckData="checks" TimezoneOffsetHours="@TimezoneOffsetHours" />
                    }
                    else if (panel.PanelType == "StatCard" && _statResults.TryGetValue(panel.Id, out var stat))
                    {
                        <DynamicPanel Panel="panel" StatData="stat" TimezoneOffsetHours="@TimezoneOffsetHours" />
                    }
                }
            </div>
        }

        @* Details section *@
        @if (_detailsPanelsCache?.Any() == true)
        {
            <div class="details-section">
                @foreach (var panel in _detailsPanelsCache)
                {
                    if (_gridResults.TryGetValue(panel.Id, out var grid))
                    {
                        <DynamicPanel Panel="panel" GridData="grid" TimezoneOffsetHours="@TimezoneOffsetHours" />
                    }
                }
            </div>
        }

        @* Bar gauge panels *@
        @if (_gaugePanelsCache?.Any() == true)
        {
            @foreach (var panel in _gaugePanelsCache)
            {
                if (_barGaugeResults.TryGetValue(panel.Id, out var gaugeData))
                {
                    <div class="chart-grid-item" style="position: relative;">
                        <button class="panel-maximize-btn" @onclick="() => MaximizePanel(panel)" title="Maximize">‚õ∂</button>
                        <DynamicPanel Panel="panel" BarGaugeData="gaugeData" TimezoneOffsetHours="@TimezoneOffsetHours" />
                    </div>
                }
            }
        }

        @* Maximized panel overlay *@
        @if (_maximizedPanel != null)
        {
            <div class="panel-maximize-overlay" @onclick="RestorePanel">
                <div class="panel-maximize-content" @onclick:stopPropagation>
                    <div class="panel-maximize-header">
                        <span class="panel-maximize-title">@_maximizedPanel.Title</span>
                        <button class="panel-maximize-close" @onclick="RestorePanel" title="Restore">‚úï</button>
                    </div>
                    <div class="panel-maximize-body">
                        <DynamicPanel Panel="@_maximizedPanelExpanded"
                                      TimeSeriesData="@(_timeSeriesResults.TryGetValue(_maximizedPanel.Id, out var mts) ? mts : null)"
                                      GridData="@(_gridResults.TryGetValue(_maximizedPanel.Id, out var mgd) ? mgd : null)"
                                      BarGaugeData="@(_barGaugeResults.TryGetValue(_maximizedPanel.Id, out var mbg) ? mbg : null)"
                                      TimezoneOffsetHours="@TimezoneOffsetHours" />
                    </div>
                </div>
            </div>
        }

        @* Chart grid - 2 column layout *@
        @if (_chartPanelsCache?.Any() == true)
        {
            <div class="chart-grid">
                @foreach (var panel in _chartPanelsCache)
                {
                    @if (panel.Layout.SpanColumns)
                    {
                        <div class="chart-grid-full chart-grid-item">
                            <button class="panel-maximize-btn" @onclick="() => MaximizePanel(panel)" title="Maximize">‚õ∂</button>
                            @RenderChartOrGrid(panel)
                        </div>
                    }
                    else
                    {
                        <div class="chart-grid-item">
                            <button class="panel-maximize-btn" @onclick="() => MaximizePanel(panel)" title="Maximize">‚õ∂</button>
                            @RenderChartOrGrid(panel)
                        </div>
                    }
                }
            </div>
        }
    }
</div>

@code {
    [Parameter] public string DashboardId { get; set; } = "";

    private DashboardDefinition? Dashboard;
    private string SelectedInstance = "";
    private string[] Instances = Array.Empty<string>();
    private int TimeRangeMinutes = 60;
    private double TimezoneOffsetHours = 0;
    private bool AutoRefresh = true;
    private bool IsLoading = true;
    private string? ErrorMessage;

    // Data results keyed by panel ID
    private ConcurrentDictionary<string, List<TimeSeriesPoint>> _timeSeriesResults = new();
    private ConcurrentDictionary<string, StatValue> _statResults = new();
    private ConcurrentDictionary<string, List<StatValue>> _barGaugeResults = new();
    private ConcurrentDictionary<string, DataTable> _gridResults = new();
    private ConcurrentDictionary<string, List<CheckStatus>> _checkResults = new();
    private ConcurrentDictionary<string, string> _panelErrors = new();

    // Cached panel lists to avoid repeated LINQ on each render
    private List<PanelDefinition>? _enabledPanelsCache;
    private List<PanelDefinition>? _statPanelsCache;
    private List<PanelDefinition>? _detailsPanelsCache;
    private List<PanelDefinition>? _gaugePanelsCache;
    private List<PanelDefinition>? _chartPanelsCache;

    // Maximize state
    private PanelDefinition? _maximizedPanel;
    private PanelDefinition? _maximizedPanelExpanded;

    private void MaximizePanel(PanelDefinition panel)
    {
        _maximizedPanel = panel;
        // Create a lightweight copy to avoid accidental mutation of original panel
        _maximizedPanelExpanded = new PanelDefinition
        {
            Id = panel.Id,
            Title = panel.Title,
            Description = panel.Description,
            Enabled = panel.Enabled,
            PanelType = panel.PanelType,
            ChartType = panel.ChartType,
            Height = panel.Height,
            RefreshIntervalSeconds = panel.RefreshIntervalSeconds,
            Layout = panel.Layout != null ? new PanelLayout { Column = panel.Layout.Column, Order = panel.Layout.Order, SpanColumns = panel.Layout.SpanColumns } : new PanelLayout(),
            Query = panel.Query != null ? new QueryPair { SqlServer = panel.Query.SqlServer, Sqlite = panel.Query.Sqlite } : new QueryPair(),
            StatUnit = panel.StatUnit,
            StatThresholdKey = panel.StatThresholdKey,
            BarGaugeThresholdKey = panel.BarGaugeThresholdKey,
            BarGaugeUnitSuffix = panel.BarGaugeUnitSuffix,
            ValueFormat = panel.ValueFormat,
            ColorThresholds = panel.ColorThresholds != null ? new List<ColorThresholdRule>(panel.ColorThresholds) : new List<ColorThresholdRule>(),
            DataGridIsClickable = panel.DataGridIsClickable,
            DataGridMaxRows = panel.DataGridMaxRows
        };
    }

    private void RestorePanel()
    {
        _maximizedPanel = null;
        _maximizedPanelExpanded = null;
    }

    private void RefreshPanelCaches()
    {
        _enabledPanelsCache = Dashboard?.Panels?.Where(p => p.Enabled).ToList() ?? new List<PanelDefinition>();
        _statPanelsCache = _enabledPanelsCache.Where(p => p.Layout.Column == 0 && (p.PanelType == "StatCard" || p.PanelType == "CheckStatus")).OrderBy(p => p.Layout.Order).ToList();
        _detailsPanelsCache = _enabledPanelsCache.Where(p => p.Layout.Column == 0 && p.PanelType == "TextCard").OrderBy(p => p.Layout.Order).ToList();
        _gaugePanelsCache = _enabledPanelsCache.Where(p => p.PanelType == "BarGauge").OrderBy(p => p.Layout.Order).ToList();
        _chartPanelsCache = _enabledPanelsCache.Where(p => p.PanelType == "TimeSeries" || p.PanelType == "DataGrid" || (p.PanelType != "StatCard" && p.PanelType != "CheckStatus" && p.PanelType != "BarGauge" && p.PanelType != "TextCard" && p.Layout.Column > 0)).OrderBy(p => p.Layout.Order).ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        RefreshService.OnRefresh += OnAutoRefresh;
        ConfigService.OnConfigChanged += OnConfigChanged;
        InstanceSelector.OnInstanceChanged += OnGlobalInstanceChanged;

        TimezoneOffsetHours = UserSettings.GetTimezoneOffset();
        Dashboard = ConfigService.Config.Dashboards.FirstOrDefault(d => string.Equals(d.Id, DashboardId, StringComparison.OrdinalIgnoreCase));

        if (Dashboard == null)
        {
            System.Diagnostics.Debug.WriteLine($"[DynamicDashboard] Dashboard '{DashboardId}' not found. Available dashboards:");
            foreach (var d in ConfigService.Config.Dashboards)
            {
                System.Diagnostics.Debug.WriteLine($"[DynamicDashboard]   - {d.Id}");
            }
        }

        // Cache panel lists
        RefreshPanelCaches();

        // Set initial server context
        var connections = ConnectionManager.GetConnections();
        var availableInstances = connections.SelectMany(c => c.GetServerList()).Distinct().ToList();
        var initialInstance = InstanceSelector.SelectedInstance ?? (availableInstances.Any() ? availableInstances[0] : "");
        SelectedInstance = initialInstance;
        SetServerContext(initialInstance);

        await LoadData();
        if (AutoRefresh) RefreshService.Start();
    }

    private async void OnGlobalInstanceChanged(string instanceName)
    {
        SelectedInstance = instanceName;
        SetServerContext(instanceName);
        await InvokeAsync(async () =>
        {
            await LoadData();
            StateHasChanged();
        });
    }
    
    private void SetServerContext(string instanceName)
    {
        var connection = ConnectionManager.GetConnections()
            .FirstOrDefault(c => c.GetServerList().Contains(instanceName));
        ConnectionManager.SetCurrentServer(connection?.Id);
    }

    private DashboardFilter BuildFilter()
    {
        var now = DateTime.Now;
        return new DashboardFilter
        {
            TimeFrom = now.AddMinutes(-TimeRangeMinutes),
            TimeTo = now,
            Instances = new[] { SelectedInstance }
        };
    }

    private async Task LoadData(CancellationToken cancellationToken = default)
    {
        if (Dashboard == null)
        {
            ErrorMessage = $"Dashboard '{DashboardId}' not found in configuration.";
            IsLoading = false;
            return;
        }

        IsLoading = true;
        ErrorMessage = null;
        _panelErrors.Clear();
        
        // Dispose old DataTables before replacing
        foreach (var dt in _gridResults.Values)
        {
            dt?.Dispose();
        }
        _gridResults.Clear();

        var filter = BuildFilter();
        await CachingExecutor.PrepareRefreshCycle(DashboardId, TimeRangeMinutes, SelectedInstance);

        var tsResults = new ConcurrentDictionary<string, List<TimeSeriesPoint>>();
        var statResults = new ConcurrentDictionary<string, StatValue>();
        var bgResults = new ConcurrentDictionary<string, List<StatValue>>();
        var gridResults = new ConcurrentDictionary<string, DataTable>();
        var checkResults = new ConcurrentDictionary<string, List<CheckStatus>>();

        var panelsToLoad = _enabledPanelsCache ?? Dashboard.Panels;

        var tasks = panelsToLoad.Select(async panel =>
            await QueryThrottle.ExecuteAsync(async () => 
            {
                await LoadPanelDataAsync(panel, filter, tsResults, statResults, bgResults, gridResults, checkResults, cancellationToken);
                return Task.CompletedTask;
            },
            cancellationToken));

        await Task.WhenAll(tasks);

        // Swap references after all tasks complete
        _timeSeriesResults = tsResults;
        _statResults = statResults;
        _barGaugeResults = bgResults;
        _gridResults = gridResults;
        _checkResults = checkResults;

        // Refresh caches in case panels changed (config reloads will also call RefreshPanelCaches)
        RefreshPanelCaches();

        IsLoading = false;
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task LoadPanelDataAsync(
    PanelDefinition panel,
    DashboardFilter filter,
    ConcurrentDictionary<string, List<TimeSeriesPoint>> tsResults,
    ConcurrentDictionary<string, StatValue> statResults,
    ConcurrentDictionary<string, List<StatValue>> bgResults,
    ConcurrentDictionary<string, DataTable> gridResults,
    ConcurrentDictionary<string, List<CheckStatus>> checkResults,
    CancellationToken cancellationToken)
    {
        try
        {
            switch (panel.PanelType)
            {
                case "TimeSeries":
                    var tsData = await CachingExecutor.ExecuteQueryAsync(panel.Id, filter, MapTimeSeriesPoint, null, cancellationToken);
                    tsResults[panel.Id] = tsData;
                    break;
                case "StatCard":
                    var dt = await CachingExecutor.ExecuteQueryAsync(panel.Id, filter, null, cancellationToken);
                    if (dt.Rows.Count > 0)
                    {
                        var val = Convert.ToDouble(dt.Rows[0]["Value"]);
                        var color = panel.ColorThresholds?.Count > 0
                            ? panel.GetThresholdColor(val)
                            : ThresholdConfig.GetColor(panel.StatThresholdKey, val);
                        statResults[panel.Id] = new StatValue { Label = panel.Title, Value = val, Unit = panel.StatUnit, Color = color };
                    }
                    break;
                case "BarGauge":
                    var bgData = await CachingExecutor.ExecuteQueryAsync(panel.Id, filter, reader =>
                    {
                        var val = Convert.ToDouble(reader["Value"]);
                        var color = panel.ColorThresholds?.Count > 0
                            ? panel.GetThresholdColor(val)
                            : ThresholdConfig.GetColor(panel.BarGaugeThresholdKey ?? "", val);
                        return new StatValue { Label = reader["Label"]?.ToString() ?? "", Value = val, Unit = reader["Unit"]?.ToString() ?? "%", Instance = reader["Instance"]?.ToString() ?? "", Color = color };
                    }, null, cancellationToken);
                    bgResults[panel.Id] = bgData;
                    break;
                case "DataGrid":
                case "TextCard":
                    var gridData = await CachingExecutor.ExecuteQueryAsync(panel.Id, filter, null, cancellationToken);
                    gridResults[panel.Id] = gridData;
                    break;
                case "CheckStatus":
                    var checkData = await CachingExecutor.ExecuteQueryAsync(panel.Id, filter, reader => new CheckStatus { Status = reader["Status"]?.ToString() ?? "OK", Count = Convert.ToInt32(reader["Count"]) }, null, cancellationToken);
                    checkResults[panel.Id] = checkData;
                    break;

                case "SessionBubble":
                    // SessionBubble is real-time only ‚Äî rendered on the dedicated /sessions page.
                    // No data loading needed here; the DynamicPanel shows a link to /sessions.
                    break;
            }
        }
        catch (Exception ex)
        {
            _panelErrors[panel.Id] = $"Panel '{panel.Id}' error: {ex.Message}";
        }
    }


    private RenderFragment RenderChartOrGrid(PanelDefinition panel) => builder =>
    {
        builder.OpenComponent<DynamicPanel>(0);
        builder.AddAttribute(1, "Panel", panel);
        builder.AddAttribute(5, "TimezoneOffsetHours", TimezoneOffsetHours);

        if (panel.PanelType == "TimeSeries" && _timeSeriesResults.TryGetValue(panel.Id, out var tsData))
            builder.AddAttribute(2, "TimeSeriesData", tsData);
        else if (panel.PanelType == "DataGrid" && _gridResults.TryGetValue(panel.Id, out var gridData))
            builder.AddAttribute(3, "GridData", gridData);
        else if (panel.PanelType == "TextCard" && _gridResults.TryGetValue(panel.Id, out var textData))
            builder.AddAttribute(4, "GridData", textData);

        builder.CloseComponent();
    };

    private async Task OnManualRefresh()
    {
        await LoadData();
    }

    /// <summary>
    /// Called when the user picks a different server connection in the toolbar.
    /// Re-fetches instances from the new server and reloads all panel data.
    /// </summary>
    private async Task OnServerConnectionChanged()
    {
        // Reset instances ‚Äî they belong to the newly-selected server
        Instances = Array.Empty<string>();
        SelectedInstance = "";
        InstanceSelector.SetSelectedInstance = "";

        try
        {
            Instances = await DataService.GetInstancesAsync();
            if (Instances.Length > 0)
            {
                SelectedInstance = Instances[0];
                InstanceSelector.SetSelectedInstance(SelectedInstance);
            }
            else
            {
                var enabledNames = ConnectionManager.GetEnabledServerNames();
                if (enabledNames.Length > 0)
                {
                    Instances = enabledNames;
                    SelectedInstance = Instances[0];
                    InstanceSelector.SetSelectedInstance(SelectedInstance);
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[DynamicDashboard:{DashboardId}] OnServerConnectionChanged GetInstances failed: {ex.Message}");
            var enabledNames = ConnectionManager.GetEnabledServerNames();
            if (enabledNames.Length > 0)
            {
                Instances = enabledNames;
                SelectedInstance = Instances[0];
                InstanceSelector.SetSelectedInstance(SelectedInstance);
            }
        }

        await LoadData();
    }

    private async void OnAutoRefresh()
    {
        try
        {
            using var cts = new System.Threading.CancellationTokenSource();
            cts.CancelAfter(TimeSpan.FromSeconds(30));
            await InvokeAsync(async () => await LoadData(cts.Token));
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[DynamicDashboard:{DashboardId}] AutoRefresh error: {ex}");
        }
    }

    private async void OnConfigChanged()
    {
        Dashboard = ConfigService.Config.Dashboards.FirstOrDefault(d => string.Equals(d.Id, DashboardId, StringComparison.OrdinalIgnoreCase));
        RefreshPanelCaches();
        await InvokeAsync(() => LoadData());
    }

    public void Dispose()
    {
        // Dispose DataTables to prevent memory leaks
        foreach (var dt in _gridResults.Values)
        {
            dt?.Dispose();
        }
        _gridResults.Clear();
        
        RefreshService.OnRefresh -= OnAutoRefresh;
        RefreshService.Stop();
        ConfigService.OnConfigChanged -= OnConfigChanged;
        InstanceSelector.OnInstanceChanged -= OnGlobalInstanceChanged;
    }

    private static TimeSeriesPoint MapTimeSeriesPoint(IDataReader reader) => new()
    {
        Time = reader["Time"] as DateTime? ?? DateTime.MinValue,
        Series = reader["Series"]?.ToString() ?? "",
        Value = reader["Value"] != DBNull.Value ? Convert.ToDouble(reader["Value"]) : 0.0
    };
}

