<!--/* In the name of God, the Merciful, the Compassionate */-->
@using ApexCharts

@using SqlHealthAssessment.Data.Models
@using System.Linq
@using System.Collections.Generic

<div class="chart-panel">
    @if (!string.IsNullOrEmpty(Title))
    {
        <div class="chart-title">@Title</div>
    }

    @if (_seriesDataCache != null && _distinctSeries != null)
    {
        <ApexChart TItem="TimeSeriesPoint"
                   Height="@Height"
                   Options="@GetChartOptions()">

            @foreach (var series in _distinctSeries)
            {
                var seriesData = _seriesDataCache.TryGetValue(series, out var sd) ? sd : new List<TimeSeriesPoint>();
                <ApexPointSeries TItem="TimeSeriesPoint"
                                 Items="@seriesData"
                                 Name="@series"
                                 SeriesType="@ChartSeriesType"
                                 XValue="@(p => p.Time)"
                                 YValue="@(p => (decimal)p.Value)" />
            }
        </ApexChart>
    }
    else
    {
        <div class="chart-empty">No data available</div>
    }
</div>

@code {
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public List<TimeSeriesPoint>? Data { get; set; }
    [Parameter] public string YAxisUnit { get; set; } = "";
    [Parameter] public int Height { get; set; } = 250;
    [Parameter] public SeriesType ChartSeriesType { get; set; } = SeriesType.Line;
    [Parameter] public int MaxDataPoints { get; set; } = 1000;
    
    // Timezone offset in hours from UTC (e.g., 13 for UTC+13 like Pacific/Auckland)
    [Parameter] public double TimezoneOffsetHours { get; set; } = 0;

    // Cached values for performance
    private List<string>? _distinctSeries;
    private Dictionary<string, List<TimeSeriesPoint>>? _seriesDataCache;
    private ApexChartOptions<TimeSeriesPoint>? _cachedOptions;
    private List<TimeSeriesPoint>? _adjustedDataCache;
    private int _lastOffset;

    // Get data with timezone adjustment applied and throttled to max points
    private List<TimeSeriesPoint> GetAdjustedData()
    {
        if (Data == null) return new List<TimeSeriesPoint>();
        
        int offsetMinutes = (int)(TimezoneOffsetHours * 60);
        
        // Reset cache if offset changed
        if (_lastOffset != offsetMinutes || _adjustedDataCache == null)
        {
            _lastOffset = offsetMinutes;
            var adjusted = Data.Select(p => new TimeSeriesPoint
            {
                Time = p.Time == DateTime.MinValue
                    ? DateTime.MinValue
                    : DateTime.SpecifyKind(p.Time.AddMinutes(offsetMinutes), DateTimeKind.Utc),
                Value = p.Value,
                Series = p.Series
            }).ToList();

            // Throttle data points if exceeds limit
            if (adjusted.Count > MaxDataPoints)
            {
                var step = adjusted.Count / MaxDataPoints;
                _adjustedDataCache = adjusted.Where((_, i) => i % step == 0).Take(MaxDataPoints).ToList();
            }
            else
            {
                _adjustedDataCache = adjusted;
            }
        }
        
        return _adjustedDataCache ?? new List<TimeSeriesPoint>();
    }

    // Memoized chart options
    private ApexChartOptions<TimeSeriesPoint> GetChartOptions()
    {
        return _cachedOptions ??= new ApexChartOptions<TimeSeriesPoint>
        {
            Chart = new Chart
            {
                Background = "transparent",
                ForeColor = "#a0a0a0",
                Toolbar = new Toolbar { Show = false },
                Zoom = new Zoom { Enabled = true },
                Animations = new Animations
                {
                    Enabled = true,
                    Easing = Easing.Easeinout,
                    Speed = 500
                }
            },
            Theme = new Theme { Mode = Mode.Dark },
            Xaxis = new XAxis
            {
                Type = XAxisType.Datetime,
                Labels = new XAxisLabels
                {
                    DatetimeFormatter = new DatetimeFormatter
                    {
                        Hour = "HH:mm",
                        Minute = "HH:mm",
                        Day = "MMM dd"
                    }
                }
            },
            Yaxis = new List<YAxis>
            {
                new YAxis
                {
                    Labels = new YAxisLabels
                    {
                        Formatter = "function(val) { return val != null ? val.toFixed(1) : ''; }"
                    }
                }
            },
            Stroke = new Stroke
            {
                Width = 2,
                Curve = Curve.Smooth
            },
            Grid = new Grid
            {
                BorderColor = "#333",
                StrokeDashArray = 3
            },
            Tooltip = new Tooltip
            {
                Theme = Mode.Dark,
                X = new TooltipX { Format = "yyyy-MM-dd HH:mm:ss" }
            },
            Legend = new Legend
            {
                Position = LegendPosition.Bottom,
                FontSize = "11px"
            },
            Colors = new List<string> { "#4caf50", "#2196f3", "#ff9800", "#f44336", "#9c27b0", "#00bcd4", "#ffeb3b", "#e91e63" }
        };
    }

    // Rebuild caches whenever data or timezone offset changes
    protected override void OnParametersSet()
    {
        _cachedOptions = null;
        _adjustedDataCache = null; // Force recompute with current offset

        if (Data != null && Data.Any())
        {
            // Build caches from timezone-adjusted data so the chart always
            // reflects the selected timezone without a data re-fetch.
            var adjustedData = GetAdjustedData();

            _distinctSeries = adjustedData
                .Select(d => d.Series)
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            _seriesDataCache = _distinctSeries
                .ToDictionary(
                    series => series,
                    series => adjustedData
                        .Where(d => string.Equals(d.Series, series, StringComparison.OrdinalIgnoreCase))
                        .ToList(),
                    StringComparer.OrdinalIgnoreCase);
        }
        else
        {
            _distinctSeries = null;
            _seriesDataCache = null;
        }
    }

}
