<!--/* In the name of God, the Merciful, the Compassionate */-->`r`n@page "/servers"
@using Microsoft.Data.SqlClient
@using SqlHealthAssessment.Data
@using SqlHealthAssessment.Data.Models
@inject ServerConnectionManager ConnectionManager

<div class="servers-page">
    <h2>Server Management</h2>
    
    <div class="servers-toolbar">
        <button class="btn btn-primary" @onclick="ShowAddDialog">‚ûï Add Server</button>
        <button class="btn btn-secondary" @onclick="RefreshAllConnections">üîÑ Refresh All</button>
    </div>

    @if (StatusMessage != null)
    {
        <div class="status-message @(IsSuccess ? "success" : "error")">
            @StatusMessage
        </div>
    }

    <div class="servers-grid">
        @foreach (var conn in Connections)
        {
            <div class="server-card @(conn.IsConnected ? "connected" : "disconnected")">
                <div class="server-header">
                    <div class="server-status">
                        @if (conn.IsConnected)
                        {
                            <span class="status-badge connected">üü¢ Connected</span>
                        }
                        else
                        {
                            <span class="status-badge disconnected">üî¥ Disconnected</span>
                        }
                    </div>
                    <div class="server-actions">
                        <button class="btn-icon" @onclick="() => TestConnection(conn)" title="Test">üîó</button>
                        <button class="btn-icon" @onclick="() => EditConnection(conn)" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon" @onclick="() => DeleteConnection(conn)" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
                
                <div class="server-details">
                    <div class="detail-row">
                        <span class="detail-label">Server(s):</span>
                        <span class="detail-value">@conn.ServerNames</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Database:</span>
                        <span class="detail-value">@conn.Database</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Auth:</span>
                        <span class="detail-value">@conn.AuthenticationDisplay</span>
                    </div>
                    @if (!string.IsNullOrEmpty(conn.Username))
                    {
                        <div class="detail-row">
                            <span class="detail-label">Username:</span>
                            <span class="detail-value">@conn.Username</span>
                        </div>
                    }
                    @if (!conn.IsEnabled)
                    {
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value" style="color: #999;">Disabled</span>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(conn.Environment))
                    {
                        <div class="detail-row">
                            <span class="detail-label">Environment:</span>
                            <span class="detail-value">@conn.Environment</span>
                        </div>
                    }
                    @if (conn.LastConnected.HasValue)
                    {
                        <div class="detail-row">
                            <span class="detail-label">Last Connected:</span>
                            <span class="detail-value">@conn.LastConnected.Value.ToString("g")</span>
                        </div>
                    }
                    @if (conn.SuccessfulServers.Count > 0)
                    {
                        <div class="detail-row">
                            <span class="detail-label">Successful:</span>
                            <span class="detail-value">@string.Join(", ", conn.SuccessfulServers)</span>
                        </div>
                    }
                </div>
            </div>
        }
        
        @if (Connections.Count == 0)
        {
            <div class="empty-state">
                <p>No servers configured. Click "Add Server" to add your first server.</p>
            </div>
        }
    </div>

    <!-- Add/Edit Dialog -->
    @if (ShowDialog)
    {
        <div class="dialog-overlay" @onclick="CloseDialog">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h3>@(IsEditing ? "Edit Server" : "Add Server")</h3>
                
                <div class="form-group">
                    <label>Server Name(s)</label>
                    <textarea @bind="EditingConnection.ServerNames" rows="3" placeholder="Enter server names (one per line, or comma-separated)"></textarea>
                    <small>Enter multiple servers to monitor them together (e.g., server1, server2, server3)</small>
                </div>

                <div class="form-group">
                    <label>Database</label>
                    <input type="text" @bind="EditingConnection.Database" placeholder="master" />
                </div>

                <div class="form-group">
                    <label>Authentication</label>
                    <div class="auth-options">
                        <label class="auth-option">
                            <input type="radio" name="authType" value="@AuthenticationTypes.Windows"
                                   checked="@(EditingAuthType == AuthenticationTypes.Windows)"
                                   @onchange="@(() => SetAuthType(AuthenticationTypes.Windows))" />
                            Windows Authentication
                        </label>
                        <label class="auth-option">
                            <input type="radio" name="authType" value="@AuthenticationTypes.SqlServer"
                                   checked="@(EditingAuthType == AuthenticationTypes.SqlServer)"
                                   @onchange="@(() => SetAuthType(AuthenticationTypes.SqlServer))" />
                            SQL Server Authentication
                        </label>
                        <label class="auth-option">
                            <input type="radio" name="authType" value="@AuthenticationTypes.EntraMFA"
                                   checked="@(EditingAuthType == AuthenticationTypes.EntraMFA)"
                                   @onchange="@(() => SetAuthType(AuthenticationTypes.EntraMFA))" />
                            Microsoft Entra MFA
                        </label>
                    </div>
                </div>

                @if (EditingAuthType == AuthenticationTypes.SqlServer)
                {
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" @bind="EditingConnection.Username" />
                    </div>

                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" @bind="EditingPassword" />
                    </div>
                }
                else if (EditingAuthType == AuthenticationTypes.EntraMFA)
                {
                    <div class="form-group">
                        <label>Email / Username (optional)</label>
                        <input type="text" @bind="EditingConnection.Username" placeholder="user@domain.com" />
                        <small>Pre-fills the login hint. Leave blank to be prompted.</small>
                    </div>
                    <div class="form-group mfa-info">
                        <small>üîê A browser window will open for interactive MFA authentication when you connect.</small>
                    </div>
                }

                <div class="form-group">
                    <label>
                        <input type="checkbox" @bind="EditingConnection.TrustServerCertificate" />
                        Trust Server Certificate
                    </label>
                </div>

                <div class="form-group">
                    <label>Connection Timeout (seconds)</label>
                    <input type="number" @bind="EditingConnection.ConnectionTimeout" min="1" max="60" />
                </div>

                <div class="dialog-actions">
                    <button class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveConnection">Save</button>
                </div>
            </div>
        </div>
    }

    <!-- Delete Confirmation Dialog -->
    @if (ShowDeleteConfirm)
    {
        <div class="dialog-overlay" @onclick="CancelDelete">
            <div class="dialog-content" @onclick:stopPropagation="true">
                <h3>Confirm Delete</h3>
                <p>Are you sure you want to delete the server connection for:</p>
                <p><strong>@ConnectionToDelete?.ServerNames</strong></p>
                <div class="dialog-actions">
                    <button class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    <button class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ServerConnection> Connections = new();
    private string? StatusMessage;
    private bool IsSuccess;
    private bool ShowDialog;
    private bool IsEditing;
    private bool ShowDeleteConfirm;
    private ServerConnection? ConnectionToDelete;
    private ServerConnection EditingConnection = new();
    private string EditingAuthType = AuthenticationTypes.Windows;
    private string EditingPassword = "";
    private bool _isTestingAll = false;

    private void SetAuthType(string authType)
    {
        EditingAuthType = authType;
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        LoadConnections();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Connections.Any() && !_isTestingAll)
        {
            _isTestingAll = true;
            await TestAllConnectionsSilently();
        }
    }

    private void LoadConnections()
    {
        Connections = ConnectionManager.GetConnections();
    }

    private void ShowAddDialog()
    {
        EditingConnection = new ServerConnection
        {
            Database = "master",
            UseWindowsAuthentication = true,
            AuthenticationType = AuthenticationTypes.Windows,
            TrustServerCertificate = true,
            ConnectionTimeout = 15
        };
        EditingAuthType = AuthenticationTypes.Windows;
        EditingPassword = "";
        IsEditing = false;
        ShowDialog = true;
    }

    private void EditConnection(ServerConnection conn)
    {
        EditingConnection = new ServerConnection
        {
            Id = conn.Id,
            ServerNames = conn.ServerNames,
            Database = conn.Database,
            UseWindowsAuthentication = conn.UseWindowsAuthentication,
            AuthenticationType = conn.AuthenticationType,
            Username = conn.Username,
            TrustServerCertificate = conn.TrustServerCertificate,
            ConnectionTimeout = conn.ConnectionTimeout,
            IsConnected = conn.IsConnected,
            IsEnabled = conn.IsEnabled,
            Environment = conn.Environment,
            Tags = new List<string>(conn.Tags),
            SuccessfulServers = new List<string>(conn.SuccessfulServers),
            LastConnected = conn.LastConnected
        };
        EditingAuthType = conn.EffectiveAuthType;
        EditingPassword = "";
        IsEditing = true;
        ShowDialog = true;
    }

    private void CloseDialog()
    {
        ShowDialog = false;
    }

    private void SaveConnection()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(EditingConnection.ServerNames))
            {
                StatusMessage = "Server name is required";
                IsSuccess = false;
                return;
            }

            // Sync auth type from radio selection
            EditingConnection.AuthenticationType = EditingAuthType;
            EditingConnection.UseWindowsAuthentication = EditingAuthType == AuthenticationTypes.Windows;

            // Set password if provided (SQL auth only)
            if (!string.IsNullOrEmpty(EditingPassword))
            {
                EditingConnection.SetPassword(EditingPassword);
            }

            if (IsEditing)
            {
                ConnectionManager.UpdateConnection(EditingConnection);
                StatusMessage = "Server connection updated successfully";
            }
            else
            {
                ConnectionManager.AddConnection(EditingConnection);
                StatusMessage = "Server connection added successfully";
            }
            
            IsSuccess = true;
            LoadConnections();
            CloseDialog();
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error saving connection: {ex.Message}";
            IsSuccess = false;
        }
    }

    private void DeleteConnection(ServerConnection conn)
    {
        ConnectionToDelete = conn;
        ShowDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        ShowDeleteConfirm = false;
        ConnectionToDelete = null;
    }

    private void ConfirmDelete()
    {
        if (ConnectionToDelete != null)
        {
            ConnectionManager.RemoveConnection(ConnectionToDelete.Id);
            StatusMessage = "Server connection deleted";
            IsSuccess = true;
            LoadConnections();
        }
        ShowDeleteConfirm = false;
        ConnectionToDelete = null;
    }

    private async Task TestConnection(ServerConnection conn)
    {
        var isMfa = conn.EffectiveAuthType == AuthenticationTypes.EntraMFA;

        StatusMessage = isMfa
            ? "Testing connection ‚Äî please complete authentication in the browser popup..."
            : "Testing connection...";
        IsSuccess = false;
        StateHasChanged();

        try
        {
            // Serialise MFA attempts so only one browser popup appears at a time
            if (isMfa) await MfaAuthenticationHelper.MfaAuthLock.WaitAsync();

            try
            {
                var serverList = conn.GetServerList();
                var successfulServers = new List<string>();

                foreach (var serverName in serverList)
                {
                    var connectionString = conn.GetConnectionString(serverName);
                    using var connection = new SqlConnection(connectionString);
                    await connection.OpenAsync();
                    successfulServers.Add(serverName);
                }

                ConnectionManager.UpdateSuccessfulServers(conn.Id, successfulServers);
                LoadConnections();

                StatusMessage = successfulServers.Count == serverList.Count
                    ? $"Successfully connected to all {successfulServers.Count} server(s)!"
                    : $"Connected to {successfulServers.Count} of {serverList.Count} servers";
                IsSuccess = true;
            }
            finally
            {
                if (isMfa) MfaAuthenticationHelper.MfaAuthLock.Release();
            }
        }
        catch (Exception ex)
        {
            if (isMfa && MfaAuthenticationHelper.IsMfaCancelledException(ex))
            {
                StatusMessage = "MFA authentication was cancelled.";
            }
            else
            {
                StatusMessage = $"Connection failed: {ex.Message}";
            }
            IsSuccess = false;
            ConnectionManager.UpdateSuccessfulServers(conn.Id, new List<string>());
            LoadConnections();
        }
    }

    /// <summary>
    /// Tests all connections silently on page load without showing status messages.
    /// Only non-MFA connections are tested automatically to avoid unexpected browser popups.
    /// </summary>
    private async Task TestAllConnectionsSilently()
    {
        var connsToTest = Connections
            .Where(c => c.IsEnabled && c.EffectiveAuthType != AuthenticationTypes.EntraMFA)
            .ToList();

        foreach (var conn in connsToTest)
        {
            try
            {
                var serverList = conn.GetServerList();
                var successfulServers = new List<string>();

                foreach (var serverName in serverList)
                {
                    try
                    {
                        var connectionString = conn.GetConnectionString(serverName);
                        using var connection = new SqlConnection(connectionString);
                        await connection.OpenAsync();
                        successfulServers.Add(serverName);
                    }
                    catch
                    {
                        // Individual server failed ‚Äî don't stop testing others
                    }
                }

                ConnectionManager.UpdateSuccessfulServers(conn.Id, successfulServers);
            }
            catch
            {
                ConnectionManager.UpdateSuccessfulServers(conn.Id, new List<string>());
            }
        }

        LoadConnections();
        await InvokeAsync(StateHasChanged);
        _isTestingAll = false;
    }

    private async Task RefreshAllConnections()
    {
        StatusMessage = "Refreshing all connections...";

        foreach (var conn in Connections)
        {
            await TestConnection(conn);
        }
    }
}
