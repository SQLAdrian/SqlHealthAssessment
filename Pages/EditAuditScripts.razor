<!--/* In the name of God, the Merciful, the Compassionate */-->
@page "/editauditscripts"

@using System
@using System.Collections.Generic
@using System.IO
@using System.Linq
@using System.Text.Json
@using SqlHealthAssessment.Data.Models
@using SqlHealthAssessment.Data
@inject DiagnosticScriptRunner ScriptRunner

<div class="bulk-edit-page">
    <h2 style="margin-bottom: 20px;">üìù Edit Audit Scripts</h2>

    <!-- Status Message -->
    @if (!string.IsNullOrEmpty(StatusMessage))
    {
        <div class="status-message @(StatusSuccess ? "success" : "error")">
            @StatusMessage
        </div>
    }

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-group">
                <label for="categoryFilter">Category:</label>
                <select id="categoryFilter" class="form-input" @bind="SelectedCategory">
                    <option value="">All Categories</option>
                    @foreach (var cat in Categories)
                    {
                        <option value="@cat">@cat</option>
                    }
                </select>
            </div>
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter" class="form-input" @bind="SelectedStatus">
                    <option value="">All</option>
                    <option value="enabled">Enabled</option>
                    <option value="disabled">Disabled</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchFilter">Search:</label>
                <input id="searchFilter" class="form-input" type="text" @bind="SearchText" placeholder="Search scripts..." />
            </div>
            <button class="btn btn-primary" @onclick="LoadScripts" disabled="@IsLoading">
                @(IsLoading ? "Loading..." : "üîç Load Scripts")
            </button>
        </div>
    </div>

    <!-- Selection Actions -->
    <div class="selection-actions">
        <span class="selection-info">
            Showing <strong>@FilteredScripts.Count</strong> of <strong>@AllScripts.Count</strong> scripts
        </span>
        <div class="selection-buttons">
            <button class="btn btn-sm" @onclick="SaveAll" disabled="@IsSaving">
                üíæ Save All Changes
            </button>
        </div>
    </div>

    <!-- Scripts Table -->
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 60px;">Order</th>
                    <th style="width: 60px;">Enabled</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th style="width: 80px;">Timeout</th>
                    <th style="width: 80px;">CSV</th>
                    <th style="width: 100px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var script in FilteredScripts)
                {
                    <tr class="@(script.Enabled ? "enabled-row" : "disabled-row")">
                        <td>
                            <input type="number" class="form-input small" @bind="script.ExecutionOrder" min="0" />
                        </td>
                        <td style="text-align: center;">
                            <input type="checkbox" @bind="script.Enabled" />
                        </td>
                        <td>
                            <strong>@script.Name</strong>
                        </td>
                        <td>
                            <input type="text" class="form-input" @bind="script.Category" />
                        </td>
                        <td>
                            <input type="text" class="form-input" @bind="script.Description" />
                        </td>
                        <td>
                            <input type="number" class="form-input small" @bind="script.TimeoutSeconds" min="10" />
                        </td>
                        <td style="text-align: center;">
                            <input type="checkbox" @bind="script.ExportToCsv" />
                        </td>
                        <td>
                            <button class="btn btn-sm" @onclick="() => EditScript(script)">‚úèÔ∏è Edit</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
@if (ShowEditModal && EditingScript != null)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Edit Script: @EditingScript.Name</h3>
                <button class="modal-close" @onclick="CloseModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ID:</label>
                    <input type="text" class="form-input" @bind="EditingScript.Id" readonly />
                </div>
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" class="form-input" @bind="EditingScript.Name" />
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea class="form-input" rows="3" @bind="EditingScript.Description"></textarea>
                </div>
                <div class="form-group">
                    <label>Script Path:</label>
                    <input type="text" class="form-input" @bind="EditingScript.ScriptPath" />
                </div>
                <div class="form-group">
                    <label>Execution Parameters:</label>
                    <input type="text" class="form-input" @bind="EditingScript.ExecutionParameters" />
                </div>
                <div class="form-group">
                    <label>SQL Query for Output:</label>
                    <textarea class="form-input" rows="3" @bind="EditingScript.SqlQueryForOutput"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Execution Order:</label>
                        <input type="number" class="form-input" @bind="EditingScript.ExecutionOrder" min="0" />
                    </div>
                    <div class="form-group">
                        <label>Timeout (seconds):</label>
                        <input type="number" class="form-input" @bind="EditingScript.TimeoutSeconds" min="10" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" @bind="EditingScript.Enabled" /> Enabled
                        </label>
                    </div>
                    <div class="form-group checkbox-group">
                        <label>
                            <input type="checkbox" @bind="EditingScript.ExportToCsv" /> Export to CSV
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Category:</label>
                    <input type="text" class="form-input" @bind="EditingScript.Category" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveScript" disabled="@IsSaving">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<ScriptConfiguration> AllScripts = new();
    private List<ScriptConfiguration> FilteredScripts = new();
    private string SelectedCategory = "";
    private string SelectedStatus = "";
    private string SearchText = "";
    private bool IsLoading = false;
    private bool IsSaving = false;
    private string StatusMessage = "";
    private bool StatusSuccess = false;
    private bool ShowEditModal = false;
    private ScriptConfiguration? EditingScript;

    private List<string> Categories => AllScripts
        .Select(s => s.Category)
        .Distinct()
        .OrderBy(c => c)
        .ToList();

    protected override void OnInitialized()
    {
        LoadScripts();
    }

    private void LoadScripts()
    {
        IsLoading = true;
        StatusMessage = "";
        
        try
        {
            AllScripts = ScriptRunner.LoadScriptConfigurations();
            ApplyFilters();
            StatusMessage = $"Loaded {AllScripts.Count} scripts";
            StatusSuccess = true;
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error loading scripts: {ex.Message}";
            StatusSuccess = false;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void ApplyFilters()
    {
        var filtered = AllScripts.AsEnumerable();

        if (!string.IsNullOrEmpty(SelectedCategory))
        {
            filtered = filtered.Where(s => s.Category.Equals(SelectedCategory, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrEmpty(SelectedStatus))
        {
            if (SelectedStatus == "enabled")
                filtered = filtered.Where(s => s.Enabled);
            else if (SelectedStatus == "disabled")
                filtered = filtered.Where(s => !s.Enabled);
        }

        if (!string.IsNullOrEmpty(SearchText))
        {
            var search = SearchText.ToLower();
            filtered = filtered.Where(s => 
                s.Name.ToLower().Contains(search) ||
                s.Description.ToLower().Contains(search) ||
                s.Category.ToLower().Contains(search));
        }

        FilteredScripts = filtered.OrderBy(s => s.ExecutionOrder).ToList();
    }

    private void EditScript(ScriptConfiguration script)
    {
        EditingScript = script;
        ShowEditModal = true;
    }

    private void CloseModal()
    {
        ShowEditModal = false;
        EditingScript = null;
    }

    private void SaveScript()
    {
        if (EditingScript == null) return;

        try
        {
            ScriptRunner.SaveScriptConfigurations(AllScripts);
            StatusMessage = $"Saved changes to script: {EditingScript.Name}";
            StatusSuccess = true;
            CloseModal();
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error saving: {ex.Message}";
            StatusSuccess = false;
        }
    }

    private async Task SaveAll()
    {
        IsSaving = true;
        StatusMessage = "";

        try
        {
            ScriptRunner.SaveScriptConfigurations(AllScripts);
            StatusMessage = $"Successfully saved {AllScripts.Count} scripts";
            StatusSuccess = true;
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error saving: {ex.Message}";
            StatusSuccess = false;
        }
        finally
        {
            IsSaving = false;
        }
    }
}

<style>
    .bulk-edit-page {
        padding: 20px;
    }

    .filter-section {
        background: var(--bg-panel);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .form-input {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 14px;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--accent);
    }

    .form-input.small {
        width: 80px;
        padding: 6px 8px;
        text-align: center;
    }

    .selection-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background: var(--bg-panel);
        border-radius: 8px;
    }

    .selection-info {
        color: var(--text-secondary);
    }

    .selection-buttons {
        display: flex;
        gap: 10px;
    }

    .table-container {
        overflow-x: auto;
        background: var(--bg-panel);
        border-radius: 8px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .data-table th {
        background: var(--bg-secondary);
        font-weight: 600;
        font-size: 13px;
    }

    .data-table tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    .enabled-row {
        border-left: 3px solid #4caf50;
    }

    .disabled-row {
        border-left: 3px solid #f44336;
        opacity: 0.7;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }

    .btn-primary {
        background: var(--accent);
        color: white;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border);
    }

    .status-message {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
    }

    .status-message.success {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid #4caf50;
        color: #4caf50;
    }

    .status-message.error {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid #f44336;
        color: #f44336;
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        background: var(--bg-panel);
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border);
    }

    .modal-header h3 {
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-secondary);
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .form-group textarea {
        width: 100%;
        resize: vertical;
    }

    .form-row {
        display: flex;
        gap: 15px;
    }

    .form-row .form-group {
        flex: 1;
    }

    .checkbox-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }
</style>
